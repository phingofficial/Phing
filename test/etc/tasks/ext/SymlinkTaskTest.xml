<?xml version="1.0" encoding="UTF-8"?>
<project name="SymlinkTaskTest" default="main">
    <property name="tmp.dir" value="tmp"/>
    <resolvepath propertyName="output" file="${tmp.dir}"/>
    <property name="file" value="${output}/file"/>
    <resolvepath propertyName="file_ref" file="${file}"/>

    <target name="setUp">
        <mkdir dir="${output}"/>
    </target>

    <target name="tearDown">
        <chmod file="${chmod.tmp}" mode="755" quiet="true"/>
        <delete dir="${chmod.tmp}" quiet="true"/>
        <delete dir="${output}" quiet="true"/>
    </target>

    <target name="init">
        <touch file="${file_ref}" />
    </target>

    <target name="testCreateDouble" depends="init">
        <symlink overwrite="true" link="${output}/link" resource="${file_ref}"/>
        <symlink overwrite="true" link="${output}/link" resource="${file_ref}"/>
    </target>


    <target name="testCreateDoubleHanging" depends="init">
        <symlink overwrite="true" link="${output}/link2" resource="${hanging_ref}"/>
        <symlink overwrite="true" link="${output}/link2" resource="${hanging_ref}"/>
    </target>

    <target name="testCreateOverFile" depends="init">
        <touch file="${output}/link3" />
        <symlink overwrite="true" link="${output}/link3" resource="${file_ref}"/>
    </target>

    <target name="testDeleteOfBrokenLink" depends="init">
        <symlink link="${output}/link" resource="${file_ref}"/>
        <delete file="${file_ref}"/>
        <symlink link="${output}/link" action="delete"/>
    </target>

    <target name="testDeleteLinkToParent" depends="init">
        <symlink link="${output}/link" resource="${output}"/>
        <symlink link="${output}/link" action="delete"/>
    </target>

    <target name="testDeleteWithNoPermissionToRenameTarget" depends="init">
        <!-- must be outside of ${output} or "base" tearDown will fail -->
        <property name="chmod.tmp" value="${output}/../phing-symlink-test"/>
        <mkdir dir="${chmod.tmp}/A"/>
        <chmod mode="555" file="${chmod.tmp}"/>
        <symlink link="${output}/link" resource="${chmod.tmp}/A"/>
        <symlink link="${output}/link" action="delete"/>
    </target>

    <target name="testDeleteLinkInSameDirAsBuildFile" depends="setUp">
        <mkdir dir="${output}/Templates"/>
        <mkdir dir="${output}/project1"/>
        <symlink action="single" link="${output}/project1/Templates" resource="../Templates"/>
        <echo file="${output}/project1/build.xml"><![CDATA[
<project name="project1" default="build" basedir=".">
    <target name="build">
        <symlink action="delete" link="Templates"/>
    </target>
</project>]]></echo>
        <phing phingfile="${output}/project1/build.xml"/>
    </target>

    <target name="main"/>
</project>
