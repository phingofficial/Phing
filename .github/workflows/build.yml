name: Phing CI

on:
  push:
  pull_request:

jobs:
#  static_code_analysis:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v2
#        name: Checkout repository
#
#      - uses: "ramsey/composer-install@v1"
#        with:
#          dependency-versions: 'locked'
#
#      - name:  Static Code Analysis
#        run: bin/phpcs -s -n --standard=./ruleset.xml classes test/classes

  test:
    runs-on: ${{ matrix.operating-system }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: true
      matrix:
        operating-system: [ ubuntu-latest, macos-latest, windows-latest ]
        php: [ '7.3', '7.4' ]    
        dependencies: [ 'lowest', 'locked' ]
        experimental:
          - false
        include:
          - php: '8.0'
            dependencies: 'highest'
            composer-options: '--ignore-platform-reqs'
            experimental: true

    name: PHP ${{ matrix.php }} on ${{ matrix.operating-system }}

    steps:
      - uses: actions/checkout@v2
        name: Checkout repository

      - name: Setup PHP
        uses: nanasess/setup-php@master
        with:
          php-version: ${{ matrix.php }}

      - uses: "ramsey/composer-install@v1"
        with:
          dependency-versions: "${{ matrix.dependencies }}"
          composer-options: "${{ matrix.composer-options }}"

      - name: Test phing
        working-directory: test
        run: | 
          echo "=== SETTING GIT IDENTITY ==="
          git config --global user.email "travis-ci-build@phing.info"
          git config --global user.name "Phing Travis Builder"
          echo "=== RUN TESTS ==="
          ../bin/phing -verbose -Dtests.codecoverage=false -listener "phing.listener.StatisticsListener"
