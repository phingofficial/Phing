name: Phing CI

on:
  push:
  pull_request:

jobs:
  static_code_analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        name: Checkout repository

      - uses: ramsey/composer-install@v1
        with:
          dependency-versions: 'locked'

      - name:  Static Code Analysis
        run: bin/phpcs -s -n --standard=./ruleset.xml classes test/classes

  test:
    needs: 
      - static_code_analysis
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ ubuntu-latest, macos-latest, windows-latest ]
        php: [ '7.3', '7.4', '8.0' ]
        dependencies: [ 'lowest', 'locked' ]

    name: PHP ${{ matrix.php }} on ${{ matrix.operating-system }} with ${{ matrix.dependencies }} dependencies

    steps:
      - uses: actions/checkout@v2
        name: Checkout repository

      - name: Setup PHP
        uses: nanasess/setup-php@master
        with:
          php-version: ${{ matrix.php }}

      - uses: ramsey/composer-install@v1
        with:
          dependency-versions: ${{ matrix.dependencies }}
          composer-options: ${{ matrix.composer-options }}

      - name: Test phing
        working-directory: test
        run: | 
          echo "=== SETTING GIT IDENTITY ==="
          git config --global user.email "travis-ci-build@phing.info"
          git config --global user.name "Phing Travis Builder"
          echo "=== RUN TESTS ==="
          ../bin/phing -verbose -Dtests.codecoverage=false -listener "phing.listener.StatisticsListener"

  coverage:
    runs-on: ubuntu-latest
    needs:
      - static_code_analysis
    steps:
      - uses: actions/checkout@v2
        name: Checkout repository

      - uses: ramsey/composer-install@v1
        with:
          dependency-versions: 'locked'

      - name: Test with coverage
        working-directory: test
        run: |
          echo "=== SETTING GIT IDENTITY ==="
          git config --global user.email "travis-ci-build@phing.info"
          git config --global user.name "Phing Travis Builder"
          echo "=== RUN TESTS ==="
          ../bin/phing -verbose -Dtests.codecoverage=true -listener "phing.listener.StatisticsListener"
